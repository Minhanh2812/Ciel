<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Learning Web App</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    .background-gradient {
      transition: opacity 1s ease-in-out;
      height: 100vh;
    }

    .sunrise .background-gradient {
      background: linear-gradient(135deg, #FF6B6B, #4ECDC4, #F7FFF7);
    }

    .day .background-gradient {
      background: linear-gradient(135deg, #87CEEB, #F0F8FF, #FFD700);
    }

    .sunset .background-gradient {
      background: linear-gradient(135deg, #FF6347, #FF8C00, #FFD700);
    }

    .night .background-gradient {
      background: linear-gradient(135deg, #0A0A2A, #281D52, #4B0082);
    }

    .stars {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 40px 70px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 50px 160px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 90px 40px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 120px 80px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 150px 10px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 170px 150px, #eee, rgba(0,0,0,0));
      background-repeat: repeat;
      background-size: 200px 200px;
      animation: twinkle 10s infinite;
    }

    .shooting-star {
      position: absolute;
      top: -100px;
      left: 50%;
      width: 2px;
      height: 100px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #fff);
      transform: rotate(45deg);
      animation: shoot 5s infinite linear;
      animation-delay: 2s;
    }

    .shooting-star-2 {
      position: absolute;
      top: -200px;
      left: 20%;
      width: 2px;
      height: 100px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #fff);
      transform: rotate(45deg);
      animation: shoot 7s infinite linear;
      animation-delay: 5s;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.5; }
    }

    @keyframes shoot {
      0% { transform: translateY(0) translateX(0) rotate(45deg); opacity: 1; }
      100% { transform: translateY(150vh) translateX(150vh) rotate(45deg); opacity: 0; }
    }

    .character {
      position: absolute;
      animation: float 15s infinite ease-in-out;
      filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
    }

    .bear {
      width: 60px;
      height: 60px;
      bottom: 10%;
      left: 5%;
      animation: moveBear 20s infinite linear;
    }
    .bear .head { background-color: #A0522D; border-radius: 50%; width: 40px; height: 40px; position: absolute; top: 10px; left: 10px; }
    .bear .ear { background-color: #A0522D; border-radius: 50%; width: 20px; height: 20px; position: absolute; }
    .bear .left-ear { top: 0; left: 0; }
    .bear .right-ear { top: 0; right: 0; }

    .smurf {
      width: 50px;
      height: 50px;
      top: 20%;
      right: 15%;
      animation: moveSmurf 18s infinite linear;
    }
    .smurf .head { background-color: #00BFFF; border-radius: 50%; width: 30px; height: 30px; position: absolute; top: 20px; left: 10px; }
    .smurf .hat { background-color: white; border-radius: 50%; width: 40px; height: 25px; position: absolute; top: 0; left: 5px; }

    .human {
      width: 50px;
      height: 70px;
      bottom: 50%;
      left: 30%;
      animation: moveHuman 22s infinite linear;
    }
    .human .head { background-color: #FFDAB9; border-radius: 50%; width: 30px; height: 30px; position: absolute; top: 0; left: 10px; }
    .human .body { background-color: #6A5ACD; border-radius: 50% 50% 10px 10px; width: 40px; height: 40px; position: absolute; top: 30px; left: 5px; }

    @keyframes moveBear {
      0% { transform: translate(0, 0); }
      25% { transform: translate(100px, 50px); }
      50% { transform: translate(200px, 0); }
      75% { transform: translate(100px, -50px); }
      100% { transform: translate(0, 0); }
    }

    @keyframes moveSmurf {
      0% { transform: translate(0, 0); }
      50% { transform: translate(-100px, 100px); }
      100% { transform: translate(0, 0); }
    }

    @keyframes moveHuman {
      0% { transform: translate(0, 0); }
      50% { transform: translate(0, -100px); }
      100% { transform: translate(0, 0); }
    }
    
    .editor-container {
        border-radius: 0.75rem; /* rounded-xl */
        border-width: 1px; /* border */
        border-color: #d1d5db; /* border-gray-300 */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
        transition: box-shadow 0.3s ease-in-out;
    }

    .editor-container:focus-within {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-2 focus:ring-blue-500 */
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const { useState, useEffect, createElement, useRef } = React;
    const { createRoot } = ReactDOM;

    // The main App component that handles navigation and state.
    function App() {
      // Use a history stack to manage navigation, allowing for a back button.
      const [pageHistory, setPageHistory] = useState(['home']);
      const currentPage = pageHistory[pageHistory.length - 1];

      const [lessons, setLessons] = useState(() => {
        try {
          const storedLessons = localStorage.getItem('lessons');
          return storedLessons ? JSON.parse(storedLessons) : [];
        } catch (e) {
          console.error("Failed to load lessons from localStorage", e);
          return [];
        }
      });
      const [flashcards, setFlashcards] = useState(() => {
        try {
          const storedFlashcards = localStorage.getItem('flashcards');
          return storedFlashcards ? JSON.parse(storedFlashcards) : [];
        } catch (e) {
          console.error("Failed to load flashcards from localStorage", e);
          return [];
        }
      });

      useEffect(() => {
        localStorage.setItem('lessons', JSON.stringify(lessons));
      }, [lessons]);

      useEffect(() => {
        localStorage.setItem('flashcards', JSON.stringify(flashcards));
      }, [flashcards]);

      // Function to navigate to a new page, pushing it to the history stack.
      const navigate = (page) => {
        setPageHistory(prevHistory => [...prevHistory, page]);
      };

      // Function to go back to the previous page by popping from the history stack.
      const goBack = () => {
        if (pageHistory.length > 1) {
          setPageHistory(prevHistory => prevHistory.slice(0, -1));
        }
      };

      const addLesson = (title, content) => {
        if (title && content) {
          setLessons([...lessons, { id: Date.now(), title, content }]);
          // Navigate to the library after saving, but don't add to history here.
          // Or, go back. Let's make it simple and just go back.
          goBack();
        }
      };

      const addSavedItem = (title, content) => {
        setLessons([...lessons, { id: Date.now(), title, content, isSavedItem: true }]);
      };

      const addFlashcard = (word, meaning, example, imageUrl) => {
        if (word && meaning) {
          setFlashcards([...flashcards, { id: Date.now(), word, meaning, example, imageUrl }]);
        }
      };

      const renderPage = () => {
        switch (currentPage) {
          case 'home':
            return createElement(Home, { navigate });
          case 'library':
            return createElement(Library, { lessons, flashcards, navigate });
          case 'lessons':
            return createElement(Lessons, { onSaveLesson: addLesson });
          case 'test':
            return createElement(Test, { lessons, onSaveItem: addSavedItem });
          case 'flashcards':
            return createElement(Flashcards, { onSaveFlashcard: addFlashcard });
          default:
            return createElement(Home, { navigate });
        }
      };

      return createElement('div', { className: 'relative min-h-screen flex flex-col' },
        createElement(Background, null),
        createElement('div', { className: 'absolute inset-0 flex flex-col z-10 p-4 overflow-y-auto' },
          createElement(Navigation, { navigate, currentPage }),
          createElement('div', { className: 'flex-grow flex items-start justify-center p-4' },
            createElement('div', { className: 'w-full max-w-4xl bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl p-8 transition-all duration-500 transform' },
              // Back button will appear here
              pageHistory.length > 1 && createElement(BackButton, { goBack }),
              renderPage()
            )
          )
        )
      );
    }

    // New Back Button component
    const BackButton = ({ goBack }) => {
      return createElement('button', {
        onClick: goBack,
        className: 'flex items-center space-x-2 px-4 py-2 mb-4 text-gray-700 bg-gray-200 rounded-full shadow-md hover:bg-gray-300 transition duration-300'
      },
        createElement('i', { className: 'fas fa-arrow-left' }),
        createElement('span', null, 'Back')
      );
    };

    // Background component with dynamic gradients and animations.
    const Background = () => {
      const [timeOfDay, setTimeOfDay] = useState('');

      useEffect(() => {
        const updateTime = () => {
          const hour = new Date().getHours();
          if (hour >= 5 && hour < 9) {
            setTimeOfDay('sunrise');
          } else if (hour >= 9 && hour < 17) {
            setTimeOfDay('day');
          } else if (hour >= 17 && hour < 20) {
            setTimeOfDay('sunset');
          } else {
            setTimeOfDay('night');
          }
        };
        updateTime();
        const interval = setInterval(updateTime, 60000);
        return () => clearInterval(interval);
      }, []);

      return createElement('div', { className: `fixed inset-0 overflow-hidden transition-all duration-1000 ${timeOfDay}` },
        createElement('div', { className: 'absolute inset-0 z-0' },
          createElement('div', { className: 'absolute inset-0 background-gradient' }),
          timeOfDay === 'night' && createElement(NightSky, null),
          createElement(AnimatedCharacters, null)
        )
      );
    };

    const NightSky = () => (
      createElement('div', { className: 'absolute inset-0' },
        createElement('div', { className: 'stars' }),
        createElement('div', { className: 'shooting-star' }),
        createElement('div', { className: 'shooting-star-2' })
      )
    );

    const AnimatedCharacters = () => {
      return (
        createElement(React.Fragment, null,
          createElement('div', { className: 'character bear' },
            createElement('div', { className: 'ear left-ear' }),
            createElement('div', { className: 'ear right-ear' }),
            createElement('div', { className: 'head' }),
            createElement('div', { className: 'body' })
          ),
          createElement('div', { className: 'character smurf' },
            createElement('div', { className: 'hat' }),
            createElement('div', { className: 'head' }),
            createElement('div', { className: 'body' })
          ),
          createElement('div', { className: 'character human' },
            createElement('div', { className: 'head' }),
            createElement('div', { className: 'body' })
          )
        )
      );
    };

    // Navigation component.
    const Navigation = ({ navigate, currentPage }) => {
      const navItems = [
        { name: 'Home', iconClass: 'fas fa-home', page: 'home' },
        { name: 'Library', iconClass: 'fas fa-book', page: 'library' },
        { name: 'Lessons', iconClass: 'fas fa-pen', page: 'lessons' },
        { name: 'Test', iconClass: 'fas fa-graduation-cap', page: 'test' },
        { name: 'Flashcards', iconClass: 'fas fa-feather-alt', page: 'flashcards' },
      ];

      return createElement('nav', { className: 'flex justify-center mb-6' },
        createElement('ul', { className: 'flex space-x-2 bg-white bg-opacity-70 backdrop-filter backdrop-blur-lg rounded-full p-2 shadow-lg' },
          navItems.map((item) => (
            createElement('li', { key: item.name },
              createElement('button', {
                onClick: () => navigate(item.page),
                className: `flex items-center space-x-2 px-4 py-2 rounded-full transition-all duration-300 font-semibold ${currentPage === item.page ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-200'}`
              },
                createElement('i', { className: item.iconClass }),
                createElement('span', { className: 'hidden sm:inline' }, item.name)
              )
            )
          ))
        )
      );
    };

    // Home page component.
    const Home = ({ navigate }) => {
      return createElement('div', { className: 'text-center' },
        createElement('h1', { className: 'text-5xl font-extrabold text-gray-800 mb-2' }, 'Welcome back!'),
        createElement('p', { className: 'text-xl text-gray-600 mb-8' }, 'Are you ready to learn?'),
        createElement('div', { className: 'space-y-4' },
          createElement('button', {
            onClick: () => navigate('library'),
            className: 'w-full md:w-2/3 lg:w-1/2 block mx-auto px-6 py-4 bg-purple-600 text-white text-xl font-bold rounded-xl shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105'
          }, 'Go to Library'),
          createElement('button', {
            onClick: () => navigate('lessons'),
            className: 'w-full md:w-2/3 lg:w-1/2 block mx-auto px-6 py-4 bg-green-600 text-white text-xl font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105'
          }, 'Create a new lesson'),
          createElement('button', {
            onClick: () => navigate('test'),
            className: 'w-full md:w-2/3 lg:w-1/2 block mx-auto px-6 py-4 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105'
          }, 'Start a test')
        )
      );
    };

    // Library page component to display saved lessons and flashcards.
    const Library = ({ lessons, flashcards }) => {
      return createElement('div', null,
        createElement('h2', { className: 'text-4xl font-bold text-gray-800 mb-6 text-center' }, 'Your Library'),
        createElement('div', { className: 'mb-8' },
          createElement('h3', { className: 'text-2xl font-bold text-gray-800 mb-4' }, 'Saved Lessons'),
          lessons.length === 0 ? (
            createElement('p', { className: 'text-center text-gray-500 text-lg' }, "You don't have any saved lessons yet.")
          ) : (
            createElement('div', { className: 'grid md:grid-cols-2 lg:grid-cols-3 gap-6' },
              lessons.map((lesson) => (
                createElement('div', { key: lesson.id, className: `bg-gray-50 p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300 ${lesson.isSavedItem ? 'bg-yellow-50' : ''}` },
                  createElement('h3', { className: 'text-xl font-bold text-blue-600 mb-2' }, lesson.title),
                  // Use dangerouslySetInnerHTML to render the rich text content
                  createElement('div', { className: 'text-gray-700 line-clamp-3 whitespace-pre-wrap', dangerouslySetInnerHTML: { __html: lesson.content } })
                )
              ))
            )
          )
        ),
        createElement('div', null,
          createElement('h3', { className: 'text-2xl font-bold text-gray-800 mb-4' }, 'Saved Flashcards'),
          flashcards.length === 0 ? (
            createElement('p', { className: 'text-center text-gray-500 text-lg' }, "You don't have any saved flashcards yet.")
          ) : (
            createElement('div', { className: 'grid md:grid-cols-2 lg:grid-cols-3 gap-6' },
              flashcards.map((card) => (
                createElement('div', { key: card.id, className: 'bg-gray-50 p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300' },
                  card.imageUrl && createElement('img', { src: card.imageUrl, alt: `Image for the word ${card.word}`, className: 'w-full h-40 object-cover rounded-md mb-4' }),
                  createElement('h4', { className: 'text-2xl font-bold text-purple-600 mb-2' }, card.word),
                  createElement('p', { className: 'text-gray-700' }, card.meaning),
                  card.example && createElement('p', { className: 'text-gray-500 italic mt-2' }, card.example)
                )
              ))
            )
          )
        )
      );
    };

    // New Test component with multiple-choice and writing sections
    const Test = ({ lessons, onSaveItem }) => {
      const [testType, setTestType] = useState(null);
      const [questions, setQuestions] = useState([]);
      const [userAnswers, setUserAnswers] = useState({});
      const [showResults, setShowResults] = useState(false);
      const [loading, setLoading] = useState(false);
      const [writingText, setWritingText] = useState('');
      const [writingFeedback, setWritingFeedback] = useState(null);
      const [writingTopic, setWritingTopic] = useState('');
      const [testConfig, setTestConfig] = useState({ topic: '', level: 'B1', numQuestions: 5, timeLimit: 0, toeicPart: 'Part 5', ieltsType: 'Academic' });
      const [timerValue, setTimerValue] = useState(0);
      const [isTestRunning, setIsTestRunning] = useState(false);
      const [isCountdown, setIsCountdown] = useState(false);
      const [ieltsPassages, setIeltsPassages] = useState([]);

      const levels = ['B1', 'B2', 'C1', 'C2', 'TOEIC', 'IELTS'];
      const toeicParts = ['Part 5', 'Part 6', 'Part 7'];
      const topicsFromLessons = lessons.map(l => l.title);
      const allTopics = ['English Grammar', 'Vocabulary', 'Science', 'History'].concat(topicsFromLessons);
      
      // Timer effect hook
      useEffect(() => {
        let timer;
        if (isTestRunning) {
          if (isCountdown) {
            if (timerValue > 0) {
              timer = setInterval(() => {
                setTimerValue(prevTime => prevTime - 1);
              }, 1000);
            } else if (timerValue === 0) {
              handleSubmitTest();
            }
          } else { // Stopwatch
            timer = setInterval(() => {
              setTimerValue(prevTime => prevTime + 1);
            }, 1000);
          }
        }
        return () => clearInterval(timer);
      }, [isTestRunning, timerValue, isCountdown]);

      // Timer formatting function
      const formatTime = (seconds) => {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
      };

      // Level change handler
      const handleLevelChange = (e) => {
        const newLevel = e.target.value;
        let newNumQuestions = testConfig.numQuestions;
        let newToeicPart = testConfig.toeicPart;
        let newTimeLimit = testConfig.timeLimit;

        if (newLevel === 'TOEIC') {
          newToeicPart = 'Part 5';
          newNumQuestions = 30;
          newTimeLimit = 0;
        } else if (newLevel === 'IELTS') {
          newNumQuestions = 40;
          newTimeLimit = 60;
        } else {
          newNumQuestions = 5;
          newTimeLimit = 0;
        }
        setTestConfig({ ...testConfig, level: newLevel, numQuestions: newNumQuestions, timeLimit: newTimeLimit, toeicPart: newToeicPart });
      };

      // TOEIC Part change handler
      const handleToeicPartChange = (e) => {
          const newPart = e.target.value;
          let newNumQuestions;
          switch (newPart) {
              case 'Part 5':
                  newNumQuestions = 30;
                  break;
              case 'Part 6':
                  newNumQuestions = 16;
                  break;
              case 'Part 7':
                  newNumQuestions = 54;
                  break;
          }
          setTestConfig({ ...testConfig, toeicPart: newPart, numQuestions: newNumQuestions });
      };

      // Handle start of multiple choice test (non-IELTS/TOEIC)
      const handleStartRegularTest = async () => {
        if (!testConfig.topic || !testConfig.numQuestions || loading) return;
        setLoading(true);

        const prompt = `Create a ${testConfig.numQuestions} question multiple-choice test on the topic of "${testConfig.topic}" at the CEFR level ${testConfig.level}. Each question should have a question text, four options, and a correct answer. The output should be a JSON array.`;
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "questionText": { "type": "STRING" },
                    "options": {
                        "type": "ARRAY",
                        "items": { "type": "STRING" }
                    },
                    "correctAnswer": { "type": "STRING" }
                },
                "propertyOrdering": ["questionText", "options", "correctAnswer"]
            }
        };

        setQuestions([]);
        setUserAnswers({});
        setShowResults(false);

        if (testConfig.timeLimit > 0) {
            setIsCountdown(true);
            setTimerValue(testConfig.timeLimit * 60);
        } else {
            setIsCountdown(false);
            setTimerValue(0);
        }
        setIsTestRunning(true);

        try {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            const json = result.candidates?.[0]?.content?.parts?.[0]?.text;
            const parsedData = JSON.parse(json);
            const questionsWithIds = parsedData.map((q, index) => ({ ...q, id: `q${index + 1}` }));
            setQuestions(questionsWithIds);
        } catch (error) {
            console.error("Error generating multiple choice questions:", error);
            setQuestions([]);
            setIsTestRunning(false);
            setTimerValue(0);
        } finally {
            setLoading(false);
        }
      };

      // New function to handle starting the IELTS reading test
      const handleStartIELTSReading = async () => {
        if (loading) return;
        setLoading(true);

        const prompt = `Create an IELTS Reading test with 3 passages and 40 questions of various types. The test should be for the ${testConfig.ieltsType} module. The question types should be a mix of:
        - Multiple Choice
        - True/False/Not Given
        - Fill in the blanks
        - Matching Headings (provide a list of headings to match)
        - Short Answer Questions.
        Each passage should be a self-contained object. The output must be a single JSON object with a 'passages' array. Each passage object should have a 'title', 'text', and a 'questions' array. Each question object should have a 'type', 'questionText', and a 'correctAnswer'. For 'fill_in_the_blanks' questions, the questionText should contain a blank space to be filled. For 'matching_headings', the passage should contain section titles and the question object should contain a list of headings to match.`;

        const responseSchema = {
          type: "OBJECT",
          properties: {
            "passages": {
              "type": "ARRAY",
              "items": {
                "type": "OBJECT",
                "properties": {
                  "title": { "type": "STRING" },
                  "text": { "type": "STRING" },
                  "questions": {
                    "type": "ARRAY",
                    "items": {
                      "type": "OBJECT",
                      "properties": {
                        "type": { "type": "STRING" }, // e.g., 'multiple_choice', 'true_false_not_given'
                        "questionText": { "type": "STRING" },
                        "options": {
                          "type": "ARRAY",
                          "items": { "type": "STRING" }
                        },
                        "correctAnswer": { "type": "STRING" }
                      }
                    }
                  }
                }
              }
            }
          }
        };

        setIeltsPassages([]);
        setQuestions([]);
        setUserAnswers({});
        setShowResults(false);
        setTimerValue(60 * 60); // 60 minutes
        setIsCountdown(true);
        setIsTestRunning(true);

        try {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            const json = result.candidates?.[0]?.content?.parts?.[0]?.text;
            const parsedData = JSON.parse(json);
            setIeltsPassages(parsedData.passages);

            let allIeltsQuestions = [];
            let questionNumber = 1;
            parsedData.passages.forEach((passage, passageIndex) => {
              passage.questions.forEach(q => {
                allIeltsQuestions.push({...q, id: `q${questionNumber}`, passageId: passageIndex });
                questionNumber++;
              });
            });
            setQuestions(allIeltsQuestions);
        } catch (error) {
            console.error("Error generating IELTS questions:", error);
            setIeltsPassages([]);
            setQuestions([]);
            setIsTestRunning(false);
            setTimerValue(0);
        } finally {
            setLoading(false);
        }
      };

      const handleAnswerChange = (questionId, value) => {
        setUserAnswers(prev => ({ ...prev, [questionId]: value }));
      };

      const handleSubmitTest = () => {
        setIsTestRunning(false);
        setShowResults(true);
      };

      const getScore = () => {
        let score = 0;
        const incorrectAnswers = [];
        questions.forEach((q) => {
            const userAnswer = userAnswers[q.id];
            if (userAnswer && userAnswer.trim().toLowerCase() === q.correctAnswer.trim().toLowerCase()) {
                score++;
            } else {
                incorrectAnswers.push({
                    questionText: q.questionText,
                    userAnswer: userAnswer || 'Not answered',
                    correctAnswer: q.correctAnswer,
                });
            }
        });
        return { score, incorrectAnswers };
      };

      const handleSaveIncorrectAnswers = (incorrectAnswers) => {
        const title = `Incorrect Answers from Test (${new Date().toLocaleDateString()})`;
        let content = "Incorrect answers:\n";
        incorrectAnswers.forEach((item, index) => {
          content += `\nQuestion ${index + 1}: ${item.questionText}\n`;
          content += `Your answer: ${item.userAnswer}\n`;
          content += `Correct answer: ${item.correctAnswer}\n`;
        });
        onSaveItem(title, content);
      };

      const handleGetWritingFeedback = async () => {
        if (!writingText.trim() || loading) return;
        setLoading(true);
        setWritingFeedback(null);
        try {
          const prompt = `Analyze the following essay and provide detailed feedback in English. Correct grammar and spelling errors, suggest better vocabulary, and comment on the sentence structure.
          Essay: "${writingText}"
          `;
          const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiKey = "";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await response.json();
          setWritingFeedback(result.candidates?.[0]?.content?.parts?.[0]?.text);
        } catch (error) {
          console.error("Error getting writing feedback:", error);
          setWritingFeedback("An error occurred while fetching feedback. Please try again.");
        } finally {
          setLoading(false);
        }
      };

      const handleGenerateWritingTopic = async () => {
        if (loading) return;
        setLoading(true);
        setWritingTopic('');
        try {
          const prompt = `Provide a random topic for a 250-word English essay. The topic should be suitable for a B1 to C2 level. Example: "The impact of social media on mental health." Return only the topic, no other text.`;
          const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiKey = "";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await response.json();
          setWritingTopic(result.candidates?.[0]?.content?.parts?.[0]?.text.trim());
        } catch (error) {
          console.error("Error generating writing topic:", error);
          setWritingTopic("Failed to generate a topic. Please try again.");
        } finally {
          setLoading(false);
        }
      };

      const handleSaveWritingFeedback = () => {
        if (writingFeedback) {
          const title = `Feedback for Essay: "${writingTopic || 'Custom Topic'}"`;
          const content = `Your Essay:\n${writingText}\n\nDetailed Feedback:\n${writingFeedback}`;
          onSaveItem(title, content);
        }
      };

      // UI to select test type
      if (!testType) {
        return createElement('div', { className: 'text-center' },
          createElement('h2', { className: 'text-4xl font-bold text-gray-800 mb-6' }, 'Choose a Test Type'),
          createElement('div', { className: 'space-y-4' },
            createElement('button', {
              onClick: () => setTestType('multiple-choice'),
              className: 'w-full md:w-2/3 lg:w-1/2 block mx-auto px-6 py-4 bg-blue-600 text-white text-xl font-bold rounded-xl shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105'
            }, 'Multiple Choice Test'),
            createElement('button', {
              onClick: () => setTestType('writing'),
              className: 'w-full md:w-2/3 lg:w-1/2 block mx-auto px-6 py-4 bg-green-600 text-white text-xl font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105'
            }, 'Essay Writing')
          )
        );
      }

      // Main Test UI
      if (testType === 'multiple-choice') {
        const { score, incorrectAnswers } = showResults ? getScore() : { score: 0, incorrectAnswers: [] };
        const isExamLevel = testConfig.level === 'TOEIC' || testConfig.level === 'IELTS';

        // IELTS Test View
        if (isTestRunning && testConfig.level === 'IELTS') {
            const currentPassage = ieltsPassages[questions.find(q => !userAnswers[q.id])?.passageId || 0];
            return createElement('div', { className: 'flex h-full' },
                // Passage column
                createElement('div', { className: 'w-1/2 overflow-y-auto pr-4 border-r border-gray-300' },
                    currentPassage && createElement('div', null,
                        createElement('h3', { className: 'text-2xl font-bold text-gray-800 mb-2' }, `Passage ${currentPassage.passageId + 1}: ${currentPassage.title}`),
                        createElement('p', { className: 'whitespace-pre-wrap text-gray-700' }, currentPassage.text)
                    )
                ),
                // Questions column
                createElement('div', { className: 'w-1/2 overflow-y-auto pl-4' },
                    createElement('div', { className: 'sticky top-0 bg-white bg-opacity-90 p-2 z-10' },
                        createElement('span', { className: 'text-lg font-bold text-gray-800' }, `Time remaining: ${formatTime(timerValue)}`)
                    ),
                    questions.map((q, qIndex) => {
                        const isCurrentPassageQuestion = q.passageId === currentPassage.passageId;
                        if (!isCurrentPassageQuestion) return null;

                        // Render question based on type
                        if (q.type === 'multiple_choice') {
                            return createElement('div', { key: q.id, className: 'mb-4' },
                                createElement('p', { className: 'font-semibold text-gray-800 mb-2' }, `${qIndex + 1}. ${q.questionText}`),
                                ...q.options.map((option, oIndex) => createElement('label', { key: oIndex, className: 'block' },
                                    createElement('input', {
                                        type: 'radio',
                                        name: `q-${q.id}`,
                                        value: option,
                                        checked: userAnswers[q.id] === option,
                                        onChange: (e) => handleAnswerChange(q.id, e.target.value)
                                    }),
                                    createElement('span', { className: 'ml-2' }, option)
                                ))
                            );
                        } else if (q.type === 'fill_in_the_blanks') {
                            return createElement('div', { key: q.id, className: 'mb-4' },
                                createElement('p', { className: 'font-semibold text-gray-800 mb-2' }, `${qIndex + 1}. ${q.questionText}`),
                                createElement('input', {
                                    type: 'text',
                                    value: userAnswers[q.id] || '',
                                    onChange: (e) => handleAnswerChange(q.id, e.target.value),
                                    className: 'border rounded p-2 w-full'
                                })
                            );
                        } else if (q.type === 'true_false_not_given') {
                            return createElement('div', { key: q.id, className: 'mb-4' },
                                createElement('p', { className: 'font-semibold text-gray-800 mb-2' }, `${qIndex + 1}. ${q.questionText}`),
                                ...['True', 'False', 'Not Given'].map(option => createElement('label', { key: option, className: 'block' },
                                    createElement('input', {
                                        type: 'radio',
                                        name: `q-${q.id}`,
                                        value: option,
                                        checked: userAnswers[q.id] === option,
                                        onChange: (e) => handleAnswerChange(q.id, e.target.value)
                                    }),
                                    createElement('span', { className: 'ml-2' }, option)
                                ))
                            );
                        } else if (q.type === 'matching_headings') {
                            return createElement('div', { key: q.id, className: 'mb-4' },
                                createElement('p', { className: 'font-semibold text-gray-800 mb-2' }, `${qIndex + 1}. ${q.questionText}`),
                                createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 'Please match the headings to the paragraphs.'),
                                createElement('input', {
                                    type: 'text',
                                    value: userAnswers[q.id] || '',
                                    onChange: (e) => handleAnswerChange(q.id, e.target.value),
                                    className: 'border rounded p-2 w-full'
                                })
                            );
                        } else if (q.type === 'short_answer') {
                            return createElement('div', { key: q.id, className: 'mb-4' },
                                createElement('p', { className: 'font-semibold text-gray-800 mb-2' }, `${qIndex + 1}. ${q.questionText}`),
                                createElement('input', {
                                    type: 'text',
                                    value: userAnswers[q.id] || '',
                                    onChange: (e) => handleAnswerChange(q.id, e.target.value),
                                    className: 'border rounded p-2 w-full'
                                })
                            );
                        }
                    }),
                    createElement('div', { className: 'mt-6 text-right' },
                        createElement('button', {
                            onClick: handleSubmitTest,
                            className: 'px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300',
                        }, 'Submit Test')
                    )
                )
            );
        }

        // Configuration View for all tests
        return createElement('div', null,
          createElement('h2', { className: 'text-4xl font-bold text-gray-800 mb-6 text-center' }, 'Multiple Choice Test'),
          isTestRunning && createElement('div', { className: 'absolute top-4 right-4 bg-white bg-opacity-80 p-2 rounded-xl shadow-md' },
            createElement('span', { className: 'text-lg font-bold text-gray-800' },
              isCountdown ? `Time remaining: ${formatTime(timerValue)}` : `Time elapsed: ${formatTime(timerValue)}`
            )
          ),
          !isTestRunning && !questions.length && !loading && createElement('div', null,
            createElement('div', { className: 'mb-4' },
              createElement('label', { className: 'block text-gray-700 font-bold mb-2' }, 'Level:'),
              createElement('select', {
                value: testConfig.level,
                onChange: handleLevelChange,
                className: 'w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500'
              },
                levels.map(l => createElement('option', { key: l, value: l }, l))
              )
            ),
            testConfig.level === 'IELTS' && createElement('div', { className: 'mb-4' },
                createElement('label', { className: 'block text-gray-700 font-bold mb-2' }, 'IELTS Type:'),
                createElement('select', {
                    value: testConfig.ieltsType,
                    onChange: (e) => setTestConfig({ ...testConfig, ieltsType: e.target.value }),
                    className: 'w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500'
                },
                    createElement('option', { value: 'Academic' }, 'Academic'),
                    createElement('option', { value: 'General' }, 'General')
                )
            ),
            testConfig.level === 'TOEIC' && createElement('div', { className: 'mb-4' },
                createElement('label', { className: 'block text-gray-700 font-bold mb-2' }, 'Select TOEIC Part:'),
                createElement('select', {
                    value: testConfig.toeicPart,
                    onChange: handleToeicPartChange,
                    className: 'w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500'
                },
                    toeicParts.map(p => createElement('option', { key: p, value: p }, p))
                )
            ),
            createElement('div', { className: 'mb-4' },
              createElement('label', { className: 'block text-gray-700 font-bold mb-2' }, 'Topic:'),
              createElement('select', {
                value: testConfig.topic,
                onChange: (e) => setTestConfig({ ...testConfig, topic: e.target.value }),
                className: `w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 ${isExamLevel ? 'bg-gray-200' : ''}`
              },
                createElement('option', { value: '' }, 'Select a topic...'),
                allTopics.map(t => createElement('option', { key: t, value: t }, t))
              ),
              !isExamLevel && createElement('input', {
                type: 'text',
                placeholder: 'Or enter your own topic...',
                value: testConfig.topic,
                onChange: (e) => setTestConfig({ ...testConfig, topic: e.target.value }),
                className: 'mt-2 w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500'
              })
            ),
            createElement('div', { className: 'mb-6 grid grid-cols-2 gap-4' },
                createElement('div', null,
                    createElement('label', { className: `block text-gray-700 font-bold mb-2 ${isExamLevel ? 'opacity-50' : ''}` }, 'Number of Questions:'),
                    createElement('input', {
                        type: 'number',
                        value: testConfig.numQuestions,
                        onChange: (e) => setTestConfig({ ...testConfig, numQuestions: parseInt(e.target.value) }),
                        min: 1,
                        max: 40,
                        disabled: isExamLevel,
                        className: 'w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-200'
                    }),
                    isExamLevel && createElement('p', { className: 'text-sm text-gray-500 mt-1' }, `Fixed number of questions for ${testConfig.level}: ${testConfig.numQuestions} questions.`)
                ),
                createElement('div', null,
                    createElement('label', { className: 'block text-gray-700 font-bold mb-2' }, 'Time (minutes):'),
                    createElement('input', {
                        type: 'number',
                        value: testConfig.timeLimit > 0 ? testConfig.timeLimit : '',
                        onChange: (e) => setTestConfig({ ...testConfig, timeLimit: parseInt(e.target.value) || 0 }),
                        min: 0,
                        disabled: testConfig.level === 'IELTS',
                        className: 'w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-200'
                    }),
                    testConfig.level === 'IELTS' && createElement('p', { className: 'text-sm text-gray-500 mt-1' }, `Fixed time for IELTS: ${testConfig.timeLimit} minutes.`)
                )
            ),
            createElement('div', { className: 'text-right' },
              createElement('button', {
                onClick: testConfig.level === 'IELTS' ? handleStartIELTSReading : handleStartRegularTest,
                disabled: (testConfig.level !== 'TOEIC' && testConfig.level !== 'IELTS' && !testConfig.topic) || loading || (testConfig.level === 'TOEIC' && !testConfig.toeicPart),
                className: 'px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50'
              }, loading ? 'Creating test...' : 'Create Test')
            )
          ),
          isTestRunning && questions.length > 0 && !showResults && createElement('div', null,
              questions.map((q, qIndex) => (
                  createElement('div', { key: q.id, className: 'mb-6 p-4 bg-gray-50 rounded-lg shadow-sm' },
                      createElement('p', { className: 'font-semibold text-gray-800 mb-2' }, `${qIndex + 1}. ${q.questionText}`),
                      createElement('div', { className: 'space-y-2' },
                          q.options.map((option, oIndex) => (
                              createElement('label', { key: oIndex, className: 'flex items-center text-gray-700' },
                                  createElement('input', {
                                      type: 'radio',
                                      name: `q-${q.id}`,
                                      value: option,
                                      checked: userAnswers[q.id] === option,
                                      onChange: (e) => handleAnswerChange(q.id, e.target.value),
                                      className: 'mr-2'
                                  }),
                                  createElement('span', null, option)
                              )
                          ))
                      )
                  )
              )),
              createElement('div', { className: 'mt-6 text-right' },
                  createElement('button', {
                      onClick: handleSubmitTest,
                      className: 'px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300',
                  }, 'Submit Test')
              )
          ),
          loading && createElement('div', { className: 'flex items-center justify-center p-8 text-lg text-gray-500' }, 'Generating questions...'),

          // Display results after test submission
          showResults && createElement('div', null,
            createElement('h3', { className: 'text-3xl font-bold text-center mb-4' }, `Your Score: ${score}/${questions.length}`),
            createElement('div', { className: 'space-y-4' },
              questions.map((q, qIndex) => (
                createElement('div', { key: q.id, className: 'p-4 rounded-lg shadow-sm border', style: { borderColor: userAnswers[q.id]?.toLowerCase() === q.correctAnswer?.toLowerCase() ? '#10B981' : '#EF4444' } },
                  createElement('p', { className: 'font-semibold mb-2', style: { color: userAnswers[q.id]?.toLowerCase() === q.correctAnswer?.toLowerCase() ? '#059669' : '#DC2626' } },
                    `${qIndex + 1}. ${q.questionText}`
                  ),
                  createElement('p', { className: 'text-gray-700' }, `Your answer: ${userAnswers[q.id] || 'Not answered'}`),
                  userAnswers[q.id]?.toLowerCase() !== q.correctAnswer?.toLowerCase() && createElement('p', { className: 'text-gray-700' }, `Correct answer: ${q.correctAnswer}`)
                )
              ))
            ),
            incorrectAnswers.length > 0 && createElement('div', { className: 'mt-6 text-right' },
              createElement('button', {
                onClick: () => handleSaveIncorrectAnswers(incorrectAnswers),
                className: 'px-6 py-3 bg-yellow-600 text-white font-bold rounded-xl shadow-md hover:bg-yellow-700 transition duration-300'
              }, 'Save Incorrect Answers')
            ),
            createElement('div', { className: 'mt-6 text-right' },
                createElement('button', {
                  onClick: () => {
                    setTestType(null);
                    setQuestions([]);
                    setUserAnswers({});
                    setShowResults(false);
                    setIsTestRunning(false);
                    setTimerValue(0);
                  },
                  className: 'px-6 py-3 bg-gray-600 text-white font-bold rounded-xl shadow-md hover:bg-gray-700 transition duration-300'
                }, 'Start New Test')
              )
          )
        );
      }

      // Writing test UI
      if (testType === 'writing') {
        return createElement('div', null,
          createElement('h2', { className: 'text-4xl font-bold text-gray-800 mb-6 text-center' }, 'Essay Writing'),
          createElement('div', { className: 'flex justify-between items-center mb-4' },
            writingTopic && createElement('p', { className: 'text-lg font-semibold text-gray-700' }, `Topic: ${writingTopic}`),
            createElement('button', {
              onClick: handleGenerateWritingTopic,
              className: 'px-4 py-2 bg-purple-600 text-white font-bold rounded-full shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50',
              disabled: loading
            }, loading ? 'Generating...' : 'Generate a random topic ✨')
          ),
          createElement('textarea', {
            value: writingText,
            onChange: (e) => setWritingText(e.target.value),
            className: 'w-full p-4 text-lg rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500',
            rows: '15',
            placeholder: 'Write your essay here...'
          }),
          createElement('div', { className: 'mt-6 text-right space-x-2' },
            createElement('button', {
              onClick: handleGetWritingFeedback,
              className: 'px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50',
              disabled: !writingText.trim() || loading
            }, loading ? 'Analyzing...' : 'Get Feedback ✨'),
            writingFeedback && createElement('button', {
              onClick: handleSaveWritingFeedback,
              className: 'px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition duration-300'
            }, 'Save feedback to library')
          ),
          writingFeedback && createElement('div', { className: 'mt-8 bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200' },
            createElement('h3', { className: 'text-2xl font-bold text-gray-800 mb-4' }, 'Detailed Feedback:'),
            createElement('p', { className: 'whitespace-pre-wrap text-gray-700' }, writingFeedback)
          ),
          createElement('div', { className: 'mt-6 text-right' },
              createElement('button', {
                onClick: () => {
                  setTestType(null);
                  setWritingText('');
                  setWritingFeedback(null);
                  setWritingTopic('');
                },
                className: 'px-6 py-3 bg-gray-600 text-white font-bold rounded-xl shadow-md hover:bg-gray-700 transition duration-300'
              }, 'Start New Test')
            )
        );
      }
    };

    // Lessons page component for creating and saving new lessons with rich text editing.
    const Lessons = ({ onSaveLesson }) => {
      const [title, setTitle] = useState('');
      const [content, setContent] = useState('');
      const editorRef = useRef(null);

      useEffect(() => {
        const savedContent = localStorage.getItem('currentLessonContent');
        if (savedContent) {
          try {
            const { savedTitle, savedContentText } = JSON.parse(savedContent);
            setTitle(savedTitle);
            if (editorRef.current) {
              editorRef.current.innerHTML = savedContentText;
            }
          } catch (e) {
            console.error("Failed to parse saved lesson content", e);
          }
        }
      }, []);

      useEffect(() => {
        const interval = setInterval(() => {
            if (editorRef.current) {
                localStorage.setItem('currentLessonContent', JSON.stringify({ savedTitle: title, savedContentText: editorRef.current.innerHTML }));
            }
        }, 1000); // Save content to localStorage every second
        return () => clearInterval(interval);
      }, [title]);

      const handleSave = () => {
        onSaveLesson(title, editorRef.current.innerHTML);
        setTitle('');
        if (editorRef.current) {
          editorRef.current.innerHTML = '';
        }
        localStorage.removeItem('currentLessonContent');
      };

      const handleFormatting = (command, value = null) => {
        document.execCommand(command, false, value);
        editorRef.current.focus();
      };

      const handleHighlight = () => {
        // Use a color for the highlight
        handleFormatting('hiliteColor', '#fcd34d'); // Tailwind's yellow-300
      };

      return createElement('div', { className: 'flex flex-col h-full' },
        createElement('h2', { className: 'text-4xl font-bold text-gray-800 mb-6 text-center' }, 'Create a New Lesson'),
        createElement('input', {
          type: 'text',
          placeholder: 'Lesson Title...',
          value: title,
          onChange: (e) => setTitle(e.target.value),
          className: 'w-full p-4 mb-4 text-xl rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500'
        }),
        // New Rich Text Editor Toolbar
        createElement('div', { className: 'flex space-x-2 p-2 bg-gray-100 rounded-t-xl border-t border-x border-gray-300' },
          createElement('button', {
            onClick: () => handleFormatting('bold'),
            className: 'px-3 py-2 text-gray-700 hover:bg-gray-200 rounded-md transition-colors'
          }, createElement('i', { className: 'fas fa-bold' })),
          createElement('button', {
            onClick: () => handleFormatting('italic'),
            className: 'px-3 py-2 text-gray-700 hover:bg-gray-200 rounded-md transition-colors'
          }, createElement('i', { className: 'fas fa-italic' })),
          createElement('button', {
            onClick: () => handleFormatting('underline'),
            className: 'px-3 py-2 text-gray-700 hover:bg-gray-200 rounded-md transition-colors'
          }, createElement('i', { className: 'fas fa-underline' })),
          createElement('button', {
            onClick: handleHighlight,
            className: 'px-3 py-2 text-gray-700 hover:bg-gray-200 rounded-md transition-colors'
          }, createElement('i', { className: 'fas fa-highlighter' }))
        ),
        // New contenteditable div for rich text
        createElement('div', {
          ref: editorRef,
          contentEditable: true,
          className: 'flex-grow w-full p-4 text-lg bg-white rounded-b-xl border-x border-b border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 h-96 overflow-y-auto'
        }),
        createElement('div', { className: 'mt-6 text-right' },
          createElement('button', {
            onClick: handleSave,
            className: 'px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition duration-300'
          }, 'Save Lesson')
        )
      );
    };

    // Flashcards page component with AI generation.
    const Flashcards = ({ onSaveFlashcard }) => {
      const [word, setWord] = useState('');
      const [meaning, setMeaning] = useState('');
      const [example, setExample] = useState('');
      const [imageUrl, setImageUrl] = useState('');
      const [loading, setLoading] = useState(false);

      const generateWithAI = async () => {
        if (!word || !meaning) {
          return;
        }
        setLoading(true);
        setExample('');
        setImageUrl('');

        try {
          const promptExample = `Create an example sentence in English using the word "${word}" which means "${meaning}".`;
          const payloadExample = { contents: [{ role: "user", parts: [{ text: promptExample }] }] };
          const apiKey = "";
          const apiUrlExample = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

          const responseExample = await fetch(apiUrlExample, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payloadExample)
          });
          const resultExample = await responseExample.json();
          const generatedExample = resultExample?.candidates?.[0]?.content?.parts?.[0]?.text;
          setExample(generatedExample || 'Unable to generate an example sentence.');

          const promptImage = `Create an illustrative image for the word "${word}" which means "${meaning}".`;
          const payloadImage = { instances: { prompt: promptImage }, parameters: { "sampleCount": 1 } };
          const apiUrlImage = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

          const responseImage = await fetch(apiUrlImage, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payloadImage)
          });
          const resultImage = await responseImage.json();
          const base64Data = resultImage?.predictions?.[0]?.bytesBase64Encoded;
          if (base64Data) {
            setImageUrl(`data:image/png;base64,${base64Data}`);
          } else {
            setImageUrl('https://placehold.co/250x250/E0E0E0/808080?text=No+Image');
          }
        } catch (error) {
          console.error("Error calling API:", error);
          setExample("An error occurred while creating an example.");
          setImageUrl('https://placehold.co/250x250/E0E0E0/808080?text=Image+Error');
        } finally {
          setLoading(false);
        }
      };

      const handleSave = () => {
        onSaveFlashcard(word, meaning, example, imageUrl);
        setWord('');
        setMeaning('');
        setExample('');
        setImageUrl('');
      };

      return createElement('div', null,
        createElement('h2', { className: 'text-4xl font-bold text-gray-800 mb-6 text-center' }, 'Create Flashcards'),
        createElement('p', { className: 'text-lg text-gray-600 mb-4 text-center' }, 'Add a word and use AI to generate an example and an image.'),
        createElement('div', { className: 'grid md:grid-cols-2 gap-6' },
          createElement('div', { className: 'col-span-1 space-y-4' },
            createElement('input', {
              type: 'text',
              placeholder: 'Word...',
              value: word,
              onChange: (e) => setWord(e.target.value),
              className: 'w-full p-4 text-lg rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500'
            }),
            createElement('input', {
              type: 'text',
              placeholder: 'Meaning...',
              value: meaning,
              onChange: (e) => setMeaning(e.target.value),
              className: 'w-full p-4 text-lg rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500'
            }),
            createElement('div', { className: 'text-right' },
              createElement('button', {
                onClick: generateWithAI,
                className: 'px-6 py-3 bg-purple-600 text-white font-bold rounded-xl shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50',
                disabled: !word || !meaning || loading
              }, loading ? 'Generating...' : 'Generate with AI ✨')
            )
          ),
          createElement('div', { className: 'col-span-1' },
            loading ? (
              createElement('div', { className: 'flex items-center justify-center h-full text-lg text-gray-500' }, 'Generating content...')
            ) : (
              createElement('div', { className: 'bg-gray-50 p-6 rounded-xl shadow-md flex flex-col items-center' },
                createElement('div', { className: 'w-64 h-64 mb-4 rounded-lg overflow-hidden border border-gray-200' },
                  imageUrl ? createElement('img', { src: imageUrl, alt: 'Illustrative image', className: 'w-full h-full object-cover' }) : createElement('div', { className: 'w-full h-full bg-gray-200 flex items-center justify-center text-gray-500' }, 'Image will appear here')
                ),
                createElement('p', { className: 'text-lg text-gray-700 text-center' }, example || 'An example sentence will appear here.')
              )
            )
          )
        ),
        createElement('div', { className: 'mt-6 text-right' },
          createElement('button', {
            onClick: handleSave,
            className: 'px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50',
            disabled: !word || !meaning || loading
          }, 'Save Flashcard')
        )
      );
    };

    window.onload = function() {
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = createRoot(rootElement);
        root.render(createElement(App, null));
      }
    };
  </script>
</body>
</html>

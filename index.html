<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CIEL</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    .background-gradient {
      transition: opacity 1s ease-in-out;
      height: 100vh;
    }

    .sunrise .background-gradient {
      background: linear-gradient(135deg, #FF6B6B, #4ECDC4, #F7FFF7);
    }

    .day .background-gradient {
      background: linear-gradient(135deg, #87CEEB, #F0F8FF, #FFD700);
    }

    .sunset .background-gradient {
      background: linear-gradient(135deg, #FF6347, #FF8C00, #FFD700);
    }

    .night .background-gradient {
      background: linear-gradient(135deg, #0A0A2A, #281D52, #4B0082);
    }

    .stars {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 40px 70px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 50px 160px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 90px 40px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 120px 80px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 150px 10px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 170px 150px, #eee, rgba(0,0,0,0));
      background-repeat: repeat;
      background-size: 200px 200px;
      animation: twinkle 10s infinite;
    }

    .shooting-star {
      position: absolute;
      top: -100px;
      left: 50%;
      width: 2px;
      height: 100px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #fff);
      transform: rotate(45deg);
      animation: shoot 5s infinite linear;
      animation-delay: 2s;
    }

    .shooting-star-2 {
      position: absolute;
      top: -200px;
      left: 20%;
      width: 2px;
      height: 100px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #fff);
      transform: rotate(45deg);
      animation: shoot 7s infinite linear;
      animation-delay: 5s;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.5; }
    }

    @keyframes shoot {
      0% { transform: translateY(0) translateX(0) rotate(45deg); opacity: 1; }
      100% { transform: translateY(150vh) translateX(150vh) rotate(45deg); opacity: 0; }
    }

    .character {
      position: absolute;
      animation: float 15s infinite ease-in-out;
      filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
    }

    .bear {
      width: 60px;
      height: 60px;
      bottom: 10%;
      left: 5%;
      animation: moveBear 20s infinite linear;
    }
    .bear .head { background-color: #A0522D; border-radius: 50%; width: 40px; height: 40px; position: absolute; top: 10px; left: 10px; }
    .bear .ear { background-color: #A0522D; border-radius: 50%; width: 20px; height: 20px; position: absolute; }
    .bear .left-ear { top: 0; left: 0; }
    .bear .right-ear { top: 0; right: 0; }

    .smurf {
      width: 50px;
      height: 50px;
      top: 20%;
      right: 15%;
      animation: moveSmurf 18s infinite linear;
    }
    .smurf .head { background-color: #00BFFF; border-radius: 50%; width: 30px; height: 30px; position: absolute; top: 20px; left: 10px; }
    .smurf .hat { background-color: white; border-radius: 50%; width: 40px; height: 25px; position: absolute; top: 0; left: 5px; }

    .human {
      width: 50px;
      height: 70px;
      bottom: 50%;
      left: 30%;
      animation: moveHuman 22s infinite linear;
    }
    .human .head { background-color: #FFDAB9; border-radius: 50%; width: 30px; height: 30px; position: absolute; top: 0; left: 10px; }
    .human .body { background-color: #6A5ACD; border-radius: 50% 50% 10px 10px; width: 40px; height: 40px; position: absolute; top: 30px; left: 5px; }

    @keyframes moveBear {
      0% { transform: translate(0, 0); }
      25% { transform: translate(100px, 50px); }
      50% { transform: translate(200px, 0); }
      75% { transform: translate(100px, -50px); }
      100% { transform: translate(0, 0); }
    }

    @keyframes moveSmurf {
      0% { transform: translate(0, 0); }
      50% { transform: translate(-100px, 100px); }
      100% { transform: translate(0, 0); }
    }

    @keyframes moveHuman {
      0% { transform: translate(0, 0); }
      50% { transform: translate(0, -100px); }
      100% { transform: translate(0, 0); }
    }
    
    .editor-container {
        border-radius: 0.75rem; /* rounded-xl */
        border-width: 1px; /* border */
        border-color: #d1d5db; /* border-gray-300 */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
        transition: box-shadow 0.3s ease-in-out;
    }

    .editor-container:focus-within {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-2 focus:ring-blue-500 */
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const { useState, useEffect, createElement, useRef } = React;
    const { createRoot } = ReactDOM;

    // The main App component that handles navigation and state.
    function App() {
      // Use a history stack to manage navigation, allowing for a back button.
      const [pageHistory, setPageHistory] = useState(['home']);
      const currentPage = pageHistory[pageHistory.length - 1];

      const [lessons, setLessons] = useState(() => {
        try {
          const storedLessons = localStorage.getItem('lessons');
          return storedLessons ? JSON.parse(storedLessons) : [];
        } catch (e) {
          console.error("Failed to load lessons from localStorage", e);
          return [];
        }
      });
      const [flashcards, setFlashcards] = useState(() => {
        try {
          const storedFlashcards = localStorage.getItem('flashcards');
          return storedFlashcards ? JSON.parse(storedFlashcards) : [];
        } catch (e) {
          console.error("Failed to load flashcards from localStorage", e);
          return [];
        }
      });

      useEffect(() => {
        localStorage.setItem('lessons', JSON.stringify(lessons));
      }, [lessons]);

      useEffect(() => {
        localStorage.setItem('flashcards', JSON.stringify(flashcards));
      }, [flashcards]);

      // Function to navigate to a new page, pushing it to the history stack.
      const navigate = (page) => {
        setPageHistory(prevHistory => [...prevHistory, page]);
      };

      // Function to go back to the previous page by popping from the history stack.
      const goBack = () => {
        if (pageHistory.length > 1) {
          setPageHistory(prevHistory => prevHistory.slice(0, -1));
        }
      };

      const addLesson = (title, content) => {
        if (title && content) {
          setLessons([...lessons, { id: Date.now(), title, content }]);
          // Navigate to the library after saving, but don't add to history here.
          // Or, go back. Let's make it simple and just go back.
          goBack();
        }
      };

      const addSavedItem = (title, content) => {
        setLessons([...lessons, { id: Date.now(), title, content, isSavedItem: true }]);
      };

      const addFlashcard = (word, meaning, example, imageUrl) => {
        if (word && meaning) {
          setFlashcards([...flashcards, { id: Date.now(), word, meaning, example, imageUrl }]);
        }
      };

      const renderPage = () => {
        switch (currentPage) {
          case 'home':
            return createElement(Home, { navigate });
          case 'library':
            return createElement(Library, { lessons, flashcards, navigate });
          case 'lessons':
            return createElement(Lessons, { onSaveLesson: addLesson });
          case 'test':
            return createElement(Test, { lessons, onSaveItem: addSavedItem });
          case 'flashcards':
            return createElement(Flashcards, { onSaveFlashcard: addFlashcard });
          default:
            return createElement(Home, { navigate });
        }
      };

      return createElement('div', { className: 'relative min-h-screen flex flex-col' },
        createElement(Background, null),
        createElement('div', { className: 'absolute inset-0 flex flex-col z-10 p-4 overflow-y-auto' },
          createElement(Navigation, { navigate, currentPage }),
          createElement('div', { className: 'flex-grow flex items-start justify-center p-4' },
            createElement('div', { className: 'w-full max-w-4xl bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl p-8 transition-all duration-500 transform' },
              // Back button will appear here
              pageHistory.length > 1 && createElement(BackButton, { goBack }),
              renderPage()
            )
          )
        )
      );
    }

    // New Back Button component
    const BackButton = ({ goBack }) => {
      return createElement('button', {
        onClick: goBack,
        className: 'flex items-center space-x-2 px-4 py-2 mb-4 text-gray-700 bg-gray-200 rounded-full shadow-md hover:bg-gray-300 transition duration-300'
      },
        createElement('i', { className: 'fas fa-arrow-left' }),
        createElement('span', null, 'Back')
      );
    };

    // Background component with dynamic gradients and animations.
    const Background = () => {
      const [timeOfDay, setTimeOfDay] = useState('');

      useEffect(() => {
        const updateTime = () => {
          const hour = new Date().getHours();
          if (hour >= 5 && hour < 9) {
            setTimeOfDay('sunrise');
          } else if (hour >= 9 && hour < 17) {
            setTimeOfDay('day');
          } else if (hour >= 17 && hour < 20) {
            setTimeOfDay('sunset');
          } else {
            setTimeOfDay('night');
          }
        };
        updateTime();
        const interval = setInterval(updateTime, 60000);
        return () => clearInterval(interval);
      }, []);

      return createElement('div', { className: `fixed inset-0 overflow-hidden transition-all duration-1000 ${timeOfDay}` },
        createElement('div', { className: 'absolute inset-0 z-0' },
          createElement('div', { className: 'absolute inset-0 background-gradient' }),
          timeOfDay === 'night' && createElement(NightSky, null),
          createElement(AnimatedCharacters, null)
        )
      );
    };

    const NightSky = () => (
      createElement('div', { className: 'absolute inset-0' },
        createElement('div', { className: 'stars' }),
        createElement('div', { className: 'shooting-star' }),
        createElement('div', { className: 'shooting-star-2' })
      )
    );

    const AnimatedCharacters = () => {
      return (
        createElement(React.Fragment, null,
          createElement('div', { className: 'character bear' },
            createElement('div', { className: 'ear left-ear' }),
            createElement('div', { className: 'ear right-ear' }),
            createElement('div', { className: 'head' }),
            createElement('div', { className: 'body' })
          ),
          createElement('div', { className: 'character smurf' },
            createElement('div', { className: 'hat' }),
            createElement('div', { className: 'head' }),
            createElement('div', { className: 'body' })
          ),
          createElement('div', { className: 'character human' },
            createElement('div', { className: 'head' }),
            createElement('div', { className: 'body' })
          )
        )
      );
    };

    // Navigation component.
    const Navigation = ({ navigate, currentPage }) => {
      const navItems = [
        { name: 'Home', iconClass: 'fas fa-home', page: 'home' },
        { name: 'Library', iconClass: 'fas fa-book', page: 'library' },
        { name: 'Lessons', iconClass: 'fas fa-pen', page: 'lessons' },
        { name: 'Test', iconClass: 'fas fa-graduation-cap', page: 'test' },
        { name: 'Flashcards', iconClass: 'fas fa-feather-alt', page: 'flashcards' },
      ];

      return createElement('nav', { className: 'flex justify-center mb-6' },
        createElement('ul', { className: 'flex space-x-2 bg-white bg-opacity-70 backdrop-filter backdrop-blur-lg rounded-full p-2 shadow-lg' },
          navItems.map((item) => (
            createElement('li', { key: item.name },
              createElement('button', {
                onClick: () => navigate(item.page),
                className: `flex items-center space-x-2 px-4 py-2 rounded-full transition-all duration-300 font-semibold ${currentPage === item.page ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-200'}`
              },
                createElement('i', { className: item.iconClass }),
                createElement('span', { className: 'hidden sm:inline' }, item.name)
              )
            )
          ))
        )
      );
    };

    // Home page component.
    const Home = ({ navigate }) => {
      return createElement('div', { className: 'text-center' },
        createElement('h1', { className: 'text-5xl font-extrabold text-gray-800 mb-2' }, 'Welcome back!'),
        createElement('p', { className: 'text-xl text-gray-600 mb-8' }, 'Are you ready to learn?'),
        createElement('div', { className: 'space-y-4' },
          createElement('button', {
            onClick: () => navigate('library'),
            className: 'w-full md:w-2/3 lg:w-1/2 block mx-auto px-6 py-4 bg-purple-600 text-white text-xl font-bold rounded-xl shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105'
          }, 'Go to Library'),
          createElement('button', {
            onClick: () => navigate('lessons'),
            className: 'w-full md:w-2/3 lg:w-1/2 block mx-auto px-6 py-4 bg-green-600 text-white text-xl font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105'
          }, 'Create a new lesson'),
          createElement('button', {
            onClick: () => navigate('test'),
            className: 'w-full md:w-2/3 lg:w-1/2 block mx-auto px-6 py-4 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105'
          }, 'Start a test')
        )
      );
    };

    // Library page component to display saved lessons and flashcards.
    const Library = ({ lessons, flashcards }) => {
      return createElement('div', null,
        createElement('h2', { className: 'text-4xl font-bold text-gray-800 mb-6 text-center' }, 'Your Library'),
        createElement('div', { className: 'mb-8' },
          createElement('h3', { className: 'text-2xl font-bold text-gray-800 mb-4' }, 'Saved Lessons'),
          lessons.length === 0 ? (
            createElement('p', { className: 'text-center text-gray-500 text-lg' }, "You don't have any saved lessons yet.")
          ) : (
            createElement('div', { className: 'grid md:grid-cols-2 lg:grid-cols-3 gap-6' },
              lessons.map((lesson) => (
                createElement('div', { key: lesson.id, className: `bg-gray-50 p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300 ${lesson.isSavedItem ? 'bg-yellow-50' : ''}` },
                  createElement('h3', { className: 'text-xl font-bold text-blue-600 mb-2' }, lesson.title),
                  // Use dangerouslySetInnerHTML to render the rich text content
                  createElement('div', { className: 'text-gray-700 line-clamp-3 whitespace-pre-wrap', dangerouslySetInnerHTML: { __html: lesson.content } })
                )
              ))
            )
          )
        ),
        createElement('div', null,
          createElement('h3', { className: 'text-2xl font-bold text-gray-800 mb-4' }, 'Saved Flashcards'),
          flashcards.length === 0 ? (
            createElement('p', { className: 'text-center text-gray-500 text-lg' }, "You don't have any saved flashcards yet.")
          ) : (
            createElement('div', { className: 'grid md:grid-cols-2 lg:grid-cols-3 gap-6' },
              flashcards.map((card) => (
                createElement('div', { key: card.id, className: 'bg-gray-50 p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300' },
                  card.imageUrl && createElement('img', { src: card.imageUrl, alt: `Image for the word ${card.word}`, className: 'w-full h-40 object-cover rounded-md mb-4' }),
                  createElement('h4', { className: 'text-2xl font-bold text-purple-600 mb-2' }, card.word),
                  createElement('p', { className: 'text-gray-700' }, card.meaning),
                  card.example && createElement('p', { className: 'text-gray-500 italic mt-2' }, card.example)
                )
              ))
            )
          )
        )
      );
    };

    // New Test component with multiple-choice and writing sections
    const Test = ({ lessons, onSaveItem }) => {
      const [testType, setTestType] = useState(null);
      const [questions, setQuestions] = useState([]);
      const [userAnswers, setUserAnswers] = useState({});
      const [showResults, setShowResults] = useState(false);
      const [loading, setLoading] = useState(false);
      const [writingText, setWritingText] = useState('');
      const [writingFeedback, setWritingFeedback] = useState(null);
      const [writingTopic, setWritingTopic] = useState('');
      const [testConfig, setTestConfig] = useState({ topic: '', level: 'B1', numQuestions: 5, timeLimit: 0, toeicPart: 'Part 5', ieltsType: 'Academic' });
      const [timerValue, setTimerValue] = useState(0);
      const [isTestRunning, setIsTestRunning] = useState(false);
      const [isCountdown, setIsCountdown] = useState(false);
      const [ieltsPassages, setIeltsPassages] = useState([]);

      const levels = ['B1', 'B2', 'C1', 'C2', 'TOEIC', 'IELTS'];
      const toeicParts = ['Part 5', 'Part 6', 'Part 7'];
      const topicsFromLessons = lessons.map(l => l.title);
      const allTopics = ['English Grammar', 'Vocabulary', 'Science', 'History'].concat(topicsFromLessons);

      // Timer effect hook
      useEffect(() => {
        let timer;
        if (isTestRunning) {
          if (isCountdown) {
            if (timerValue > 0) {
              timer = setInterval(() => {
                setTimerValue(prevTime => prevTime - 1);
              }, 1000);
            } else if (timerValue === 0) {
              handleSubmitTest();
            }
          } else {
            // Stopwatch
            timer = setInterval(() => {
              setTimerValue(prevTime => prevTime + 1);
            }, 1000);
          }
        }
        return () => clearInterval(timer);
      }, [isTestRunning, timerValue, isCountdown]);

      // Timer formatting function
      const formatTime = (seconds) => {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
      };
      
      // Function to handle API calls with exponential backoff
      const callGeminiApi = async (userPrompt, callback, onLoading, responseSchema = null, model = 'gemini-2.5-flash-preview-05-20') => {
        onLoading(true);
        let retries = 0;
        const maxRetries = 5;
        const baseDelay = 1000;
        const apiKey = "DÁN KHÓA API CỦA BẠN VÀO ĐÂY";

        if (!apiKey || apiKey === "DÁN KHÓA API CỦA BẠN VÀO ĐÂY") {
          console.error("Lỗi: Không tìm thấy khóa API. Vui lòng thêm khóa API của bạn.");
          onLoading(false);
          return;
        }

        while (retries < maxRetries) {
          try {
            const chatHistory = [{ role: "user", parts: [{ text: userPrompt }] }];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const payload = { contents: chatHistory };
            if (responseSchema) {
              payload.generationConfig = { responseMimeType: "application/json", responseSchema };
            }

            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!response.ok) {
              throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
              const content = result.candidates[0].content.parts[0].text;
              callback(content);
              break;
            } else {
              throw new Error("Không nhận được nội dung hợp lệ từ API.");
            }
          } catch (e) {
            console.error("Lỗi khi gọi API:", e);
            retries++;
            if (retries < maxRetries) {
              const delay = baseDelay * (2 ** (retries - 1));
              console.log(`Retrying in ${delay}ms...`);
              await new Promise(res => setTimeout(res, delay));
            }
          } finally {
            onLoading(false);
          }
        }
      };

      // Level change handler
      const handleLevelChange = (e) => {
        const newLevel = e.target.value;
        let newNumQuestions = testConfig.numQuestions;
        let newToeicPart = testConfig.toeicPart;
        let newTimeLimit = testConfig.timeLimit;
        
        if (newLevel === 'TOEIC') {
          newToeicPart = 'Part 5';
          newNumQuestions = 30;
          newTimeLimit = 0;
        } else if (newLevel === 'IELTS') {
          newNumQuestions = 40;
          newTimeLimit = 60;
        } else {
          newNumQuestions = 5;
          newTimeLimit = 0;
        }
        setTestConfig({ ...testConfig, level: newLevel, numQuestions: newNumQuestions, timeLimit: newTimeLimit, toeicPart: newToeicPart });
      };

      // TOEIC Part change handler
      const handleToeicPartChange = (e) => {
        const newPart = e.target.value;
        let newNumQuestions;
        switch (newPart) {
          case 'Part 5': newNumQuestions = 30; break;
          case 'Part 6': newNumQuestions = 16; break;
          case 'Part 7': newNumQuestions = 54; break;
        }
        setTestConfig({ ...testConfig, toeicPart: newPart, numQuestions: newNumQuestions });
      };
      
      const handleStartRegularTest = async () => {
        if (!testConfig.topic || !testConfig.numQuestions || loading) return;

        setLoading(true);
        const prompt = `Create a ${testConfig.numQuestions} question multiple-choice test on the topic of "${testConfig.topic}" at the CEFR level ${testConfig.level}. Each question should have a question text, four options, and a correct answer. The output should be a JSON array.`;
        const responseSchema = {
          type: "ARRAY",
          items: {
            type: "OBJECT",
            properties: {
              "questionText": { "type": "STRING" },
              "options": { "type": "ARRAY", "items": { "type": "STRING" } },
              "correctAnswer": { "type": "STRING" }
            },
            "propertyOrdering": ["questionText", "options", "correctAnswer"]
          }
        };

        const callback = (content) => {
          try {
            const parsedQuestions = JSON.parse(content);
            setQuestions(parsedQuestions);
            setShowResults(false);
            setUserAnswers({});
            setIsTestRunning(true);
            setTimerValue(0);
            setIsCountdown(false);
          } catch (e) {
            console.error("Failed to parse JSON response:", e);
            alert("Failed to create test. Please try again.");
          }
        };

        callGeminiApi(prompt, callback, setLoading, responseSchema);
      };

      const handleStartWritingTest = async () => {
        if (!testConfig.topic || loading) return;
        setLoading(true);

        const prompt = `Generate an essay topic for an English writing test at the CEFR level ${testConfig.level} on the topic of "${testConfig.topic}". The topic should be a clear question or statement. For example: 'Write an essay about the advantages and disadvantages of remote work.'`;
        const callback = (topic) => {
          setWritingTopic(topic);
          setWritingText('');
          setWritingFeedback(null);
          setIsTestRunning(true);
          setTimerValue(0);
          setIsCountdown(false);
        };
        callGeminiApi(prompt, callback, setLoading);
      };

      // Function to get feedback for the writing test
      const handleGetWritingFeedback = async () => {
        if (!writingText || loading) return;
        setLoading(true);
        const feedbackPrompt = `Please provide constructive feedback on the following English essay written by an intermediate learner. Focus on grammar, spelling, sentence structure, and overall coherence. Provide specific suggestions for improvement. Highlight errors and explain why they are wrong. Present the feedback in a clear, formatted way. Here is the essay: \n\n${writingText}`;
        const callback = (feedback) => {
          setWritingFeedback(feedback);
        };
        callGeminiApi(feedbackPrompt, callback, setLoading);
      };

      const handleSubmitTest = () => {
        setIsTestRunning(false);
        setShowResults(true);
      };

      const scoreTest = () => {
        let score = 0;
        questions.forEach((q, index) => {
          if (userAnswers[index] === q.correctAnswer) {
            score++;
          }
        });
        return score;
      };

      const handleChangeAnswer = (e, index) => {
        setUserAnswers({ ...userAnswers, [index]: e.target.value });
      };

      const TestSetup = () => {
        return createElement('div', { className: 'space-y-4' },
          createElement('h3', { className: 'text-2xl font-bold text-gray-800' }, 'Configure Your Test'),
          createElement('div', { className: 'flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4' },
            createElement('select', {
              className: 'p-2 border rounded-md w-full',
              value: testConfig.level,
              onChange: handleLevelChange
            }, levels.map(level => createElement('option', { key: level, value: level }, level))),
            testConfig.level === 'TOEIC' && createElement('select', {
              className: 'p-2 border rounded-md w-full',
              value: testConfig.toeicPart,
              onChange: handleToeicPartChange
            }, toeicParts.map(part => createElement('option', { key: part, value: part }, part))),
            testConfig.level !== 'TOEIC' && testConfig.level !== 'IELTS' && createElement('select', {
              className: 'p-2 border rounded-md w-full',
              value: testConfig.topic,
              onChange: (e) => setTestConfig({ ...testConfig, topic: e.target.value })
            },
              createElement('option', { value: '' }, 'Select a Topic'),
              allTopics.map(topic => createElement('option', { key: topic, value: topic }, topic))
            )
          ),
          createElement('div', { className: 'flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4' },
            createElement('button', {
              onClick: () => { setTestType('multiple-choice'); handleStartRegularTest(); },
              disabled: loading || !testConfig.topic || testConfig.level === 'TOEIC' || testConfig.level === 'IELTS',
              className: 'flex-1 px-4 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50'
            }, 'Start Multiple Choice'),
            createElement('button', {
              onClick: () => { setTestType('writing'); handleStartWritingTest(); },
              disabled: loading || !testConfig.topic,
              className: 'flex-1 px-4 py-3 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50'
            }, 'Start Writing Test')
          ),
          loading && createElement('div', { className: 'text-center text-gray-500' }, 'Generating test... please wait.')
        );
      };

      const WritingTest = () => {
        return createElement('div', null,
          writingTopic && createElement('div', { className: 'p-4 bg-gray-50 rounded-lg mb-4' },
            createElement('h4', { className: 'text-xl font-semibold mb-2' }, 'Writing Topic:'),
            createElement('p', { className: 'text-lg text-gray-700' }, writingTopic)
          ),
          createElement('div', { className: 'text-right text-sm text-gray-500 mb-2' }, `Time elapsed: ${formatTime(timerValue)}`),
          createElement('div', { className: 'editor-container p-4 min-h-[300px] bg-white text-gray-800', contentEditable: true, onInput: (e) => setWritingText(e.target.innerHTML), dangerouslySetInnerHTML: { __html: writingText } }),
          createElement('div', { className: 'mt-4 flex justify-between items-center' },
            createElement('button', {
              onClick: () => {
                if (window.confirm("Are you sure you want to end the test and get feedback?")) {
                  setIsTestRunning(false);
                  handleGetWritingFeedback();
                }
              },
              className: 'px-4 py-2 bg-red-500 text-white font-bold rounded-xl shadow-md hover:bg-red-600 transition duration-300 disabled:opacity-50',
              disabled: loading || !writingText
            }, 'Submit for Feedback'),
            loading && createElement('span', { className: 'text-gray-500' }, 'Generating feedback...'),
          ),
          writingFeedback && createElement('div', { className: 'mt-6 p-4 bg-yellow-50 rounded-xl shadow-inner' },
            createElement('h4', { className: 'text-xl font-bold text-gray-800 mb-2' }, 'AI Feedback:'),
            createElement('div', { className: 'prose max-w-none text-gray-700', dangerouslySetInnerHTML: { __html: writingFeedback } })
          )
        );
      };

      const MultipleChoiceTest = () => {
        return createElement('div', null,
          createElement('div', { className: 'text-right text-sm text-gray-500 mb-2' }, `Time elapsed: ${formatTime(timerValue)}`),
          !showResults ? (
            createElement('form', { onSubmit: (e) => { e.preventDefault(); handleSubmitTest(); } },
              questions.map((q, qIndex) => (
                createElement('div', { key: qIndex, className: 'mb-6 p-4 bg-gray-50 rounded-xl shadow-sm' },
                  createElement('p', { className: 'font-bold text-lg text-gray-800 mb-2' }, `${qIndex + 1}. ${q.questionText}`),
                  q.options.map((option, oIndex) => (
                    createElement('label', { key: oIndex, className: 'flex items-center space-x-2 mb-1 cursor-pointer hover:bg-gray-100 p-2 rounded-lg' },
                      createElement('input', {
                        type: 'radio',
                        name: `question-${qIndex}`,
                        value: option,
                        checked: userAnswers[qIndex] === option,
                        onChange: (e) => handleChangeAnswer(e, qIndex),
                        className: 'form-radio text-blue-600'
                      }),
                      createElement('span', { className: 'text-gray-700' }, option)
                    )
                  ))
                )
              )),
              createElement('button', {
                type: 'submit',
                className: 'w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-md hover:bg-indigo-700 transition duration-300'
              }, 'Submit Test')
            )
          ) : (
            createElement('div', null,
              createElement('h4', { className: 'text-3xl font-bold text-center mb-4' }, `Your Score: ${scoreTest()} / ${questions.length}`),
              questions.map((q, qIndex) => (
                createElement('div', { key: qIndex, className: `mb-4 p-4 rounded-xl ${userAnswers[qIndex] === q.correctAnswer ? 'bg-green-100' : 'bg-red-100'}` },
                  createElement('p', { className: 'font-bold text-lg' }, `${qIndex + 1}. ${q.questionText}`),
                  createElement('p', { className: 'mt-2' },
                    createElement('span', { className: 'font-bold' }, 'Your Answer: '),
                    createElement('span', { className: userAnswers[qIndex] === q.correctAnswer ? 'text-green-700' : 'text-red-700' }, userAnswers[qIndex] || 'No answer')
                  ),
                  createElement('p', null,
                    createElement('span', { className: 'font-bold' }, 'Correct Answer: '),
                    createElement('span', { className: 'text-green-700' }, q.correctAnswer)
                  )
                )
              ))
            )
          )
        );
      };

      if (isTestRunning) {
        if (testType === 'writing') return createElement(WritingTest, null);
        if (testType === 'multiple-choice') return createElement(MultipleChoiceTest, null);
      }

      return createElement('div', null,
        createElement('h2', { className: 'text-4xl font-bold text-gray-800 mb-6 text-center' }, 'Test Your Knowledge'),
        !testType && createElement(TestSetup, null),
        (testType === 'multiple-choice' && questions.length === 0 && !loading) && createElement('p', { className: 'text-center text-gray-500 mt-4' }, "No questions generated yet. Please configure and start a test.")
      );
    };

    // New Lessons component for creating and saving rich text content
    const Lessons = ({ onSaveLesson }) => {
      const [title, setTitle] = useState('');
      const [content, setContent] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const contentRef = useRef(null);
      
      // Function to apply text formatting
      const applyFormat = (command) => {
        document.execCommand(command, false, null);
        contentRef.current.focus();
      };
      
      const handleGenerateContent = async () => {
        if (!title || isGenerating) return;
        setIsGenerating(true);
        const prompt = `Generate a comprehensive English lesson on the topic of "${title}". The lesson should include an introduction, key vocabulary with definitions and example sentences, and a short text or dialogue. The content should be suitable for intermediate learners and formatted with headings, bold text for key terms, and bullet points.`;
        
        const callback = (generatedContent) => {
          // Replace generated Markdown with appropriate HTML tags
          const formattedContent = generatedContent
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^- (.*)/gm, '<li>$1</li>')
            .replace(/^(#+)\s*(.*)/gm, (match, p1, p2) => {
              const tag = `h${p1.length}`;
              return `<${tag}>${p2}</${tag}>`;
            });
          setContent(formattedContent);
        };
        
        const callGeminiApi = async (userPrompt, callback, onLoading, responseSchema = null, model = 'gemini-2.5-flash-preview-05-20') => {
          onLoading(true);
          let retries = 0;
          const maxRetries = 5;
          const baseDelay = 1000;
          const apiKey = "DÁN KHÓA API CỦA BẠN VÀO ĐÂY";

          if (!apiKey || apiKey === "DÁN KHÓA API CỦA BẠN VÀO ĐÂY") {
            console.error("Lỗi: Không tìm thấy khóa API. Vui lòng thêm khóa API của bạn.");
            onLoading(false);
            return;
          }

          while (retries < maxRetries) {
            try {
              const chatHistory = [{ role: "user", parts: [{ text: userPrompt }] }];
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
              
              const payload = { contents: chatHistory };
              if (responseSchema) {
                payload.generationConfig = { responseMimeType: "application/json", responseSchema };
              }
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
              }

              const result = await response.json();
              
              if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const content = result.candidates[0].content.parts[0].text;
                callback(content);
                break;
              } else {
                throw new Error("Không nhận được nội dung hợp lệ từ API.");
              }
            } catch (e) {
              console.error("Lỗi khi gọi API:", e);
              retries++;
              if (retries < maxRetries) {
                const delay = baseDelay * (2 ** (retries - 1));
                console.log(`Retrying in ${delay}ms...`);
                await new Promise(res => setTimeout(res, delay));
              }
            } finally {
              onLoading(false);
            }
          }
        };

        callGeminiApi(prompt, callback, setIsGenerating);
      };
      
      return createElement('div', { className: 'space-y-6' },
        createElement('h2', { className: 'text-4xl font-bold text-gray-800 text-center' }, 'Create a New Lesson'),
        createElement('div', { className: 'flex items-center space-x-4' },
          createElement('input', {
            type: 'text',
            placeholder: 'Enter lesson title (e.g., Present Simple Tense)',
            value: title,
            onChange: (e) => setTitle(e.target.value),
            className: 'flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500'
          }),
          createElement('button', {
            onClick: handleGenerateContent,
            disabled: !title || isGenerating,
            className: 'px-6 py-3 bg-purple-600 text-white font-bold rounded-xl shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50'
          }, isGenerating ? 'Generating...' : 'Generate Content')
        ),
        
        createElement('div', { className: 'bg-white p-6 rounded-xl shadow-lg' },
          createElement('div', { className: 'flex items-center space-x-2 mb-4 p-2 bg-gray-100 rounded-md' },
            createElement('button', { onClick: () => applyFormat('bold'), className: 'p-1 text-gray-600 hover:text-gray-900 font-bold' }, 'B'),
            createElement('button', { onClick: () => applyFormat('italic'), className: 'p-1 text-gray-600 hover:text-gray-900 italic' }, 'I'),
            createElement('button', { onClick: () => applyFormat('underline'), className: 'p-1 text-gray-600 hover:text-gray-900 underline' }, 'U')
          ),
          createElement('div', {
            ref: contentRef,
            contentEditable: true,
            className: 'editor-container p-4 min-h-[400px] bg-white text-gray-800'
          })
        ),
        
        createElement('div', { className: 'text-right' },
          createElement('button', {
            onClick: () => onSaveLesson(title, contentRef.current.innerHTML),
            className: 'px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50',
            disabled: !title || !contentRef.current || !contentRef.current.innerHTML
          }, 'Save Lesson')
        )
      );
    };

    // New Flashcards component
    const Flashcards = ({ onSaveFlashcard }) => {
      const [word, setWord] = useState('');
      const [meaning, setMeaning] = useState('');
      const [example, setExample] = useState('');
      const [imageUrl, setImageUrl] = useState('');
      const [loading, setLoading] = useState(false);
      
      const handleGenerateContent = async () => {
        if (!word || loading) return;
        setLoading(true);
        
        const prompt = `Provide the definition, an example sentence, and generate a small, illustrative image for the word "${word}". Return the response as a JSON object with 'meaning', 'example', and 'imageUrl'. The image URL should be a placeholder image URL, for example: 'https://placehold.co/150x150/f0f0f0/333333?text=Placeholder'`;
        
        const responseSchema = {
          type: "OBJECT",
          properties: {
            "meaning": { "type": "STRING" },
            "example": { "type": "STRING" },
            "imageUrl": { "type": "STRING" }
          },
          "propertyOrdering": ["meaning", "example", "imageUrl"]
        };
        
        const callback = (content) => {
          try {
            const parsedContent = JSON.parse(content);
            setMeaning(parsedContent.meaning);
            setExample(parsedContent.example);
            setImageUrl(parsedContent.imageUrl);
          } catch (e) {
            console.error("Failed to parse JSON response:", e);
            alert("Failed to generate content. Please try again.");
          }
        };

        const callGeminiApi = async (userPrompt, callback, onLoading, responseSchema = null, model = 'gemini-2.5-flash-preview-05-20') => {
          onLoading(true);
          let retries = 0;
          const maxRetries = 5;
          const baseDelay = 1000;
          const apiKey = "DÁN KHÓA API CỦA BẠN VÀO ĐÂY";

          if (!apiKey || apiKey === "AIzaSyC20sIyIo96gexn-C9vnROtWNUPsG3HuFE") {
            console.error("Lỗi: Không tìm thấy khóa API. Vui lòng thêm khóa API của bạn.");
            onLoading(false);
            return;
          }

          while (retries < maxRetries) {
            try {
              const chatHistory = [{ role: "user", parts: [{ text: userPrompt }] }];
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
              
              const payload = { contents: chatHistory };
              if (responseSchema) {
                payload.generationConfig = { responseMimeType: "application/json", responseSchema };
              }
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
              }

              const result = await response.json();
              
              if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const content = result.candidates[0].content.parts[0].text;
                callback(content);
                break;
              } else {
                throw new Error("Không nhận được nội dung hợp lệ từ API.");
              }
            } catch (e) {
              console.error("Lỗi khi gọi API:", e);
              retries++;
              if (retries < maxRetries) {
                const delay = baseDelay * (2 ** (retries - 1));
                console.log(`Retrying in ${delay}ms...`);
                await new Promise(res => setTimeout(res, delay));
              }
            } finally {
              onLoading(false);
            }
          }
        };

        callGeminiApi(prompt, callback, setLoading, responseSchema);
      };
      
      const handleSave = () => {
        if (word && meaning) {
          onSaveFlashcard(word, meaning, example, imageUrl);
          setWord('');
          setMeaning('');
          setExample('');
          setImageUrl('');
        }
      };

      return createElement('div', { className: 'space-y-6' },
        createElement('h2', { className: 'text-4xl font-bold text-gray-800 text-center' }, 'Create New Flashcard'),
        createElement('div', { className: 'flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4' },
          createElement('input', {
            type: 'text',
            placeholder: 'Enter a word (e.g., Serendipity)',
            value: word,
            onChange: (e) => setWord(e.target.value),
            className: 'flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500'
          }),
          createElement('button', {
            onClick: handleGenerateContent,
            disabled: !word || loading,
            className: 'px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50'
          }, loading ? 'Generating...' : 'Generate Content')
        ),
        
        createElement('div', { className: 'mt-6 bg-white p-6 rounded-xl shadow-lg' },
          createElement('div', { className: 'text-center' },
            loading ? (
              createElement('div', { className: 'flex items-center justify-center h-full text-lg text-gray-500' }, 'Generating content...')
            ) : (
              createElement('div', { className: 'bg-gray-50 p-6 rounded-xl shadow-md flex flex-col items-center' },
                createElement('div', { className: 'w-64 h-64 mb-4 rounded-lg overflow-hidden border border-gray-200' },
                  imageUrl ? createElement('img', { src: imageUrl, alt: 'Illustrative image', className: 'w-full h-full object-cover' }) : createElement('div', { className: 'w-full h-full bg-gray-200 flex items-center justify-center text-gray-500' }, 'Image will appear here')
                ),
                createElement('p', { className: 'text-lg text-gray-700 text-center' }, meaning || 'Meaning will appear here.'),
                createElement('p', { className: 'text-gray-500 italic text-center' }, example || 'An example sentence will appear here.')
              )
            )
          )
        ),
        createElement('div', { className: 'mt-6 text-right' },
          createElement('button', {
            onClick: handleSave,
            className: 'px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50',
            disabled: !word || !meaning || loading
          }, 'Save Flashcard')
        )
      );
    };

    window.onload = function() {
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = createRoot(rootElement);
        root.render(createElement(App));
      }
    };
  </script>
</body>
</html>
